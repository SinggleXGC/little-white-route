# Hystrix简介

## 分布式系统面临的问题

复杂分布式体系结构中的应用程序有数个依赖关系，每个依赖关系在某些时候将不可避免的失败。这会发生服务雪崩。



## 服务雪崩

多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的**扇出**。如果扇出的链路上某个微服务的调用响应时间过长或不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，这就是所谓的**雪崩效应**。



## 什么是Hystrix

Hystrix是一个用于处理分布式系统的**延迟**和**容错**的开源库，在分布式系统里，许多依赖会不可避免的会调用失败，比如超时、异常等。Hystrix能够保证一个依赖在出问题的情况下，不会导致整体服务失败，**避免级联故障，以提高分布式系统的弹性**。

“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控，**向调用方返回一个符合预期的，可处理的备选响应(FallBack)，而不是长时间的等待或者抛出调用方无法处理的异常**，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。



## Hystrix能够干什么

服务降级，服务熔断，接近实时的监控等。



### 服务降级(fallback)

向调用方返回一个符合预期的，可处理的备选响应。

会触发服务降级的情况

- 程序运行异常
- 超时
- 服务熔断触发服务降级
- 线程池/信号量打满也会导致服务降级



### 服务熔断

类似保险丝，达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回友好提示。

熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。

当检测到该节点微服务调用响应正常后，恢复调用链路。



在Spring Cloud框架中，熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的情况。

当失败的调用达到一定阈值，缺省是5秒内20次失败，就会启动熔断机制。熔断机制的注解是@HystrixCommand。



断路器状态图如下：

在closed状态下，服务可以正常的访问

当失败达到一定阈值之后，断路器就会变成open状态，此时不允许任何请求。

经过一段时间后，断路器就会变成Half Open状态，此时会放行一部分请求。如果这些成功，那么断路器就会变成closed状态。

![](./img/state.png)





### 服务限流

秒杀高并发等操作，禁止大量的请求，让请求排队，有序进行处理





