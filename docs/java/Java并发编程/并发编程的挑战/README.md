# 并发编程的挑战

并发编程的目的是为了提高程序运行的速度。但是，并不是启动更多的线程就能让程序最大限度的并发执行。在并发编程中，面临着许多挑战。



## 上下文的切换

即便是单核处理器也支持多线程执行代码。这是通过时间片轮询来实现的，当一个线程执行完一个时间片，便会将CPU让给下一个线程。但是，在切换前线程会保存当前的状态，以便下一次切换成这个线程时，可以恢复当前状态。这个从保存到再次加载的过程就是上下文切换。

显然，过多的上下文切换会降低程序的运行速度。



### 如何减少上下文切换

- 无锁并发编程。多线程竞争锁的时候，会引起上下文切换，所以多线程处理数据的时候，可以使用一些办法来避免使用锁。比如，将数据的ID按照HASH算法取模分段，不同的线程处理不同段的数据。
- CAS算法。Java的Atomic包使用CAS算法来更新数据，而不需要加锁。
- 使用最少线程。避免创建不必要的线程。
- 协程。在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。



## 死锁

在多线程情况下会出现死锁问题。一旦出现死锁，程序就不能继续提供服务了。

下面是几种常见的避免死锁的方法：

- 避免一个线程获取多个锁
- 避免一个线程在锁内占用多个资源，尽量保证每个锁只占用一个资源
- 尝试使用定时锁，使用`lock.tryLock(timeout)`来替代使用內部锁机制
- 对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况



## 资源限制的挑战

### 什么是资源限制?

资源限制的意思是：在进行并发编程时，程序的运行速度受限于计算机的硬件资源和软件资源。例如，服务器的带宽只有2Mb/s，某个资源的下载速度是1Mb/s每秒，系统启动10个线程下载资源，下载速度不会变成10Mb/s。



### 资源限制引起的问题

将代码执行速度加快的原则是：将代码中串行执行的部分变成并发执行。但是，如果将某段串行执行的代码变成并发执行，因为受限于计算机资源导致实际上只是串行执行，那么由于上下文切换增加的开销，会导致程序运行更慢。



### 如何解决资源限制的问题？

对于硬件资源限制，可以考虑使用集群并发执行程序。

对于软件资源限制，可以考虑使用资源池将资源复用。如：连接池。



### 如何在资源限制情况下，让程序执行的更快？

方法是：根据不同的资源限制调整程序的并发度。



